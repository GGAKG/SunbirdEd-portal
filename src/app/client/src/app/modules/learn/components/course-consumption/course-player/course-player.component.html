<!-- Accordion and batch card section start -->
<div *ngIf="!loader" [appTelemetryStart]="telemetryCourseStart" [appTelemetryEnd]="telemetryCourseEndEvent">
  <div [appTelemetryImpression]="telemetryCourseImpression">
    <div class="sb-g sb-g--gap24">
      <div class="sb-g-col-xs-12 sb-g-col-md-9 sb-g-col-lg-9 sb-g-col-xxxl-12">
        {{ generaliseLabelService?.frmelmnts?.lbl?.LastUpdatedOn }}
        <!-- Course details for mobile view -->
        <!-- <div class="sb-bg-color-white p-8 mb-16 mobile only"
          *ngIf="enrolledBatchInfo?.cert_templates; else noMobileCertificate">
          <div class="certified-course__certificate d-inline-flex flex-ai-center py-8 px-16 width-100">
            <img src="assets/images/certificate-icon.png" alt="Certificate">
            <span
              class="fnormal sb-color-primary ml-16 font-weight-bold">{{generaliseLabelService?.frmelmnts?.lbl?.courseContainCertificate}}</span>
          </div>
        </div>

        <ng-template #noMobileCertificate>
          <div class="sb-bg-color-white p-8 mb-16 mobile only">
            <div class="certified-course__certificate d-inline-flex flex-ai-center py-8 px-16 width-100">
              <img src="assets/images/certificate-icon.png" alt="Certificate">
              <span
                class="fnormal sb-color-primary ml-16 font-weight-bold">{{generaliseLabelService?.frmelmnts?.lbl?.courseDontContainCertificate}}</span>
            </div>
          </div>
        </ng-template> -->

        <div *ngIf="isEnrolledCourseUpdated" class="mobile only">
          <div class="bgcolor-warn p-16 my-16 d-flex flex-ai-center">
            <mat-icon class="mr-8">warning</mat-icon> {{ generaliseLabelService?.frmelmnts?.lbl?.courseLastUpdatedOn }} {{
              courseHierarchy?.lastUpdatedOn | date:'dd/MM/yyyy' }}
          </div>
        </div>

        <div class="mat-bg-white p-8 mb-16 mobile only"
          *ngIf="enrolledCourse && !enrolledBatchInfo?.cert_templates">
          <div class="d-inline-flex flex-ai-center py-8 px-16 width-100">
            <img src="assets/images/certificate-icon.png" alt="Certificate">
            <span
              class="mat-body-1 color-accent ml-16 font-weight-bold">{{generaliseLabelService?.frmelmnts?.lbl?.courseDontContainCertificate}}</span>
          </div>
        </div>

        <!-- Course details displayed on top when course is not enrolled -->
        <app-course-details [courseHierarchy]="courseHierarchy" *ngIf="!enrolledCourse"></app-course-details>

        <div class="my-16">
          <div class="d-flex flex-ai-center mb-16">
            <h3 class="mb-0 mat-title">
              {{resourceService?.frmelmnts?.lbl?.coursestructure}}</h3>
            <button *ngIf="!isExpandedAll" mat-raised-button
              class="button-rounded ml-auto d-flex flex-ai-center color-accent" tabindex="0"
              (click)="isExpandedAll = true; logTelemetry('expand-all', courseHierarchy);"><mat-icon>add</mat-icon> {{resourceService?.frmelmnts?.lbl?.expandAll}}</button>
            <button *ngIf="isExpandedAll" mat-raised-button class="button-rounded ml-auto d-flex flex-ai-center color-accent" tabindex="0"
              (click)="isExpandedAll = false; logTelemetry('collapse-all', courseHierarchy);"><mat-icon>remove</mat-icon> {{resourceService?.frmelmnts?.lbl?.collapseAll}}</button>
          </div>

          <mat-accordion *ngFor="let item of courseHierarchy?.children; let index = index" [multi]="false">
            <mat-expansion-panel class="mat-app-background mb-16" [expanded]="isExpanded(index)"
              (collapsedChange)="collapsedChange($event, index)" [collapsed]="item?.collapsed">
              <mat-expansion-panel-header (click)="isModuleExpanded = true;" tabindex="0">
                <mat-panel-title tabindex="0" title class="mat-caption-1 mb-0 color-accent">
                  <i class="icon-svg icon-svg--sm icon-tick mr-8" role="img" aria-label="tick-icon"
                    *ngIf="enrolledCourse && item?.consumedContent === item?.contentCount">
                    <svg class="icon">
                      <use xlink:href="./assets/images/sprite.svg#circle-with-check-symbol"></use>
                    </svg>
                  </i>
                  <div class="progress-circle progress-circle--sm mr-8" [attr.data-percentage]="item?.progress"
                    *ngIf="enrolledCourse && item?.consumedContent > 0 && item?.consumedContent !== item?.contentCount">
                    <svg class="progress-circle__svg" viewport="0 0 2000 2000">
                      <circle class="progress-circle__stroke" r="50%" cx="50%" cy="50%"></circle>
                      <circle class="progress-circle__stroke" r="50%" cx="50%" cy="50%"></circle>
                    </svg>
                  </div>
                  {{item?.name}}
                </mat-panel-title>
              </mat-expansion-panel-header>
                <div *ngIf="item;else noContent">
                  <div *ngIf="item?.mimeType !== 'application/vnd.ekstep.content-collection' && !item?.children?.length">
                    <div class="course-player-list">
                      <sb-toc-card [content]="item" (tocCardClick)="navigateToContent($event, item, 'toc-card')" [type]="cardType"
                        [contentStatus]="contentStatus" [maxAttempts]="item?.maxAttempts" [scoreLabel]="'Best Score'"
                        [disabled]="'disabled-toc-card'">
                      </sb-toc-card>
                    </div>
                  </div>
                  <div *ngIf="item?.children?.length">
                    <div *ngFor="let child of item?.children" class="course-player-list">
                      <!-- toc card for Non Self Assess content -->
                      <sb-toc-child-item
                        *ngIf="child?.contentType !== 'SelfAssess' && child?.mimeType !== 'application/vnd.sunbird.questionset'"
                        [childData]="child" class=""
                        (tocCardClick)="navigateToContent($event, item, 'child-item')" [contentStatus]="contentStatus"
                        [type]="cardType">
                      </sb-toc-child-item>
                      <!-- toc card for Self Assess content with Label for Best Score -->
                      <sb-toc-child-item
                        *ngIf="child?.contentType === 'SelfAssess' || child?.mimeType === 'application/vnd.sunbird.questionset'"
                        [childData]="child" class=""
                        (tocCardClick)="navigateToContent($event, item, 'child-item')" [contentStatus]="contentStatus"
                        [type]="cardType" [maxAttempts]="child?.maxAttempts" [scoreLabel]="'Best Score'"
                        [disabled]="'disabled-toc-card'">
                      </sb-toc-child-item>
                    </div>
                  </div>
                </div>
                <ng-template #noContent>
                  <div class="heading">{{noContentMessage}}</div>
                </ng-template>
            </mat-expansion-panel>
          </mat-accordion>
        </div>

        <!-- Course details displayed on bottom when course is enrolled -->
        <app-course-details [courseHierarchy]="courseHierarchy" *ngIf="enrolledCourse"></app-course-details>

      </div>
      <div class="sb-course-details__info sb-g-col-xs-12 sb-g-col-md-3 sb-g-col-lg-3 sb-g-col-xxxl-4">

        <!-- <div class="sb-bg-color-white p-8 mb-16 computer only" *ngIf="enrolledBatchInfo?.cert_templates; else noCertificate">
          <div class="certified-course__certificate d-inline-flex flex-ai-center py-8 px-16 width-100">
            <img src="assets/images/certificate-icon.png" alt="Certificate">
            <span
              class="fnormal sb-color-primary ml-16 font-weight-bold">{{generaliseLabelService?.frmelmnts?.lbl?.courseContainCertificate}}</span>
          </div>
        </div>

        <ng-template #noCertificate>
          <div class="sb-bg-color-white p-8 mb-16 computer only">
            <div class="certified-course__certificate d-inline-flex flex-ai-center py-8 px-16 width-100">
              <img src="assets/images/certificate-icon.png" alt="Certificate">
              <span
                class="fnormal sb-color-primary ml-16 font-weight-bold">{{generaliseLabelService?.frmelmnts?.lbl?.courseDontContainCertificate}}</span>
            </div>
          </div>
        </ng-template> -->

        <div *ngIf="isEnrolledCourseUpdated" class="computer only">
          <div class="bgcolor-warn my-16 d-flex flex-ai-center">
            <mat-icon class="mr-8">warning</mat-icon> {{ generaliseLabelService?.frmelmnts?.lbl?.courseLastUpdatedOn }} {{
              courseHierarchy?.lastUpdatedOn | date:'dd/MM/yyyy' }}
          </div>
        </div>

        <div class="mat-bg-white p-8 mb-16 computer only"
          *ngIf="enrolledCourse && certificateDescription && !certificateDescription?.isCertificate">
          <div class="d-inline-flex flex-ai-center py-8 px-16 width-100">
            <img src="assets/images/certificate-icon.png" alt="Certificate">
            <span
              class="mat-body-1 color-accent ml-16 font-weight-bold">{{generaliseLabelService?.frmelmnts?.lbl?.courseDontContainCertificate}}</span>
          </div>
        </div>

        <div class="mat-bg-white p-8 mb-16 computer only"
          *ngIf="enrolledCourse && certificateDescription && certificateDescription?.description">
          <div class="d-inline-flex flex-ai-center p-8 width-100">
            <img src="assets/images/certificate-icon.png" alt="Certificate">
            <span
              class="mat-body-1 color-accent ml-16 font-weight-bold">{{generaliseLabelService?.frmelmnts?.lbl?.courseContainCertificate}}</span>
          </div>
          <p class="mat-caption px-4 pt-8"> {{certificateDescription?.description}} </p>
        </div>

        <!-- 2. Course Progress bar -->
        <div class="mat-bg-white certified-course__progress p-16 mb-16"
          *ngIf="enrolledCourse && !addToGroup && !courseMentor">
          <div class="mat-caption relative9">
            <button mat-icon-button [matMenuTriggerFor]="beforeMenu" class="pull-right" tabindex="0" (click)="dropdownMenu();">
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #beforeMenu="matMenu" xPosition="before">
              <button mat-menu-item (click)="forceSync()" tabindex="0">{{resourceService?.frmelmnts?.lbl?.forceSync}}</button>
            </mat-menu>
          </div>
          <div class="mat-caption">{{resourceService?.frmelmnts?.lbl?.courseProgress}}</div>
          <div class="mat-body-1 color-accent font-weight-bold mt-8">{{progressToDisplay}}%
            <span>{{resourceService?.frmelmnts?.lbl?.completed}}</span></div>
          <mat-progress-bar mode="determinate" [value]="progressToDisplay" class="mb-0 mr-0 mt-8 tiny"></mat-progress-bar>
        </div>

        <!-- 3. Join batch, leave batch and show batch popup-->
        <app-batch-details *ngIf="courseStatus !== 'Unlisted'" [courseId]="courseId" [batchId]="batchId"
          [enrolledCourse]="enrolledCourse" [enrolledBatchInfo]="enrolledBatchInfo" [courseHierarchy]="courseHierarchy"
          [courseProgressData]="courseProgressData" (allBatchDetails)="getAllBatchDetails($event)"></app-batch-details>

        <!-- Consent to share PII  -->
        <div class="mb-16" *ngIf="showDataSettingSection && isConnected">
          <app-global-consent-pii [collection]="courseHierarchy" [isglobalConsent]="false" [type]="courseConsent"
            [consentConfig]="consentConfig"></app-global-consent-pii>
        </div>

        <!-- Credits & License information -->
        <div class="course-player--metadata text-left mt-16">
          <app-course-info [courseHierarchy]="courseHierarchy"></app-course-info>
        </div>

      </div>
    </div>
  </div>
</div>

<router-outlet></router-outlet>

<app-modal-wrapper [config]="{disableClose: false, width: '30rem', size: 'small'}" *ngIf="showJoinTrainingModal"
  (dismiss)="showJoinTrainingModal = false; logTelemetry('join-training-popup-close')">
  <ng-template sbModalContent let-data>
    <!--Header-->
    <div mat-dialog-title class="mb-0">
      <h2 class="mb-0">{{generaliseLabelService?.frmelmnts?.btn?.enroll}}</h2>
      <button mat-mini-fab color="warn" class="ml-auto" aria-label="close dialog"
        mat-dialog-close><mat-icon>close</mat-icon></button>
    </div>
    <!--/Header-->
    <!--Content-->
    <mat-dialog-content class="text-center mat-body-2">
      <p>{{batchMessage}}</p>
    </mat-dialog-content>
    <!--/Content-->

  </ng-template>
</app-modal-wrapper>

<app-modal-wrapper *ngIf="shareLinkModal" [config]="{disableClose: false, panelClass: 'material-modal'}"
  (dismiss)="closeSharePopup('close-share-link-popup')">
  <ng-template sbModalContent>
    <app-share-link [shareLink]="shareLink" [telemetryShareData]="telemetryShareData">
    </app-share-link>
  </ng-template>
</app-modal-wrapper>

<app-confirmation-popup *ngIf="showConfirmationPopup" [popupMode]="popupMode" [batchId]="createdBatchId"
  (close)="onPopupClose($event)"></app-confirmation-popup>


<app-course-completion *ngIf="showCourseCompleteMessage" [certificateDescription]="certificateDescription"
  (close)="onCourseCompleteClose()"></app-course-completion>
<!-- Start - Modal for Assessment attempts -->
  <app-modal-wrapper *ngIf="showLastAttemptsModal" [config]="{disableClose: false, size: 'small', width: '30rem'}" #modal>
    <ng-template sbModalContent>
      <div mat-dialog-title class="mb-0">
        <button mat-mini-fab color="warn" class="ml-auto" aria-label="close dialog"
          mat-dialog-close><mat-icon>close</mat-icon></button>
      </div>
      <mat-dialog-content>
        <h4 class="font-weight-normal mb-0 py-24">
          {{resourceService?.frmelmnts?.lbl?.selfAssessLastAttempt}}
        </h4>
      </mat-dialog-content>
      <mat-dialog-actions align="end">
        <button mat-raised-button class="button-rounded mr-8" tabindex="0" (click)="showLastAttemptsModal = false;">
          {{resourceService.frmelmnts?.btn?.cancel}}
        </button>
        <button mat-raised-button color="accent" class="button-rounded" tabindex="0"
        (click)="showLastAttemptsModal = false; _navigateToContent();">
        {{resourceService.frmelmnts?.btn?.ok}}
      </button>
      </mat-dialog-actions>
  
    </ng-template>
  </app-modal-wrapper>
<!-- End - Modal for Assessment attempts -->